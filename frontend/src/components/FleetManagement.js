import React, { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useAuth } from '../contexts/AuthContext';\nimport { toast } from 'sonner';\nimport EquipmentManagement from './EquipmentManagement';\nimport DriverManagement from './DriverManagement';\nimport LocationTracking from './LocationTracking';\n\nconst FleetManagement = () => {\n  const { user, fetchWithAuth } = useAuth();\n  const [fleetStats, setFleetStats] = useState({\n    totalEquipment: 0,\n    availableEquipment: 0,\n    onDutyEquipment: 0,\n    totalDrivers: 0,\n    activeDrivers: 0,\n    totalRevenue: 0,\n    activeBookings: 0,\n    utilizationRate: 0\n  });\n  const [recentActivity, setRecentActivity] = useState([]);\n  const [equipment, setEquipment] = useState([]);\n  const [drivers, setDrivers] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [activeTab, setActiveTab] = useState('overview');\n\n  const BACKEND_URL = process.env.REACT_APP_BACKEND_URL;\n\n  useEffect(() => {\n    loadFleetData();\n  }, []);\n\n  const loadFleetData = async () => {\n    try {\n      // Load equipment data\n      const equipmentResponse = await fetchWithAuth(`${BACKEND_URL}/api/equipment/my`);\n      if (equipmentResponse.ok) {\n        const equipmentData = await equipmentResponse.json();\n        setEquipment(equipmentData);\n        \n        const available = equipmentData.filter(eq => eq.is_available).length;\n        const onDuty = equipmentData.filter(eq => !eq.is_available && eq.current_driver_id).length;\n        \n        setFleetStats(prev => ({\n          ...prev,\n          totalEquipment: equipmentData.length,\n          availableEquipment: available,\n          onDutyEquipment: onDuty,\n          utilizationRate: equipmentData.length > 0 ? Math.round((onDuty / equipmentData.length) * 100) : 0\n        }));\n      }\n\n      // Load drivers data\n      const driversResponse = await fetchWithAuth(`${BACKEND_URL}/api/drivers/my`);\n      if (driversResponse.ok) {\n        const driversData = await driversResponse.json();\n        setDrivers(driversData);\n        \n        const activeDriversCount = driversData.filter(driver => driver.is_active).length;\n        setFleetStats(prev => ({\n          ...prev,\n          totalDrivers: driversData.length,\n          activeDrivers: activeDriversCount\n        }));\n      }\n\n      // Load booking data for revenue and active bookings\n      const bookingsResponse = await fetchWithAuth(`${BACKEND_URL}/api/bookings/requests`);\n      if (bookingsResponse.ok) {\n        const bookingsData = await bookingsResponse.json();\n        \n        const activeBookings = bookingsData.filter(booking => \n          ['pending', 'approved'].includes(booking.status)\n        ).length;\n        \n        const totalRevenue = bookingsData\n          .filter(booking => booking.status === 'completed')\n          .reduce((sum, booking) => sum + (booking.total_cost || 0), 0);\n        \n        setFleetStats(prev => ({\n          ...prev,\n          activeBookings,\n          totalRevenue\n        }));\n        \n        // Generate recent activity from bookings\n        const recentActivities = bookingsData\n          .slice(0, 5)\n          .map(booking => ({\n            id: booking.id,\n            type: 'booking',\n            description: `New booking for ${getEquipmentName(booking.equipment_id)}`,\n            timestamp: booking.created_at,\n            status: booking.status,\n            amount: booking.total_cost\n          }));\n        \n        setRecentActivity(recentActivities);\n      }\n\n    } catch (error) {\n      toast.error('Error loading fleet data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const getEquipmentName = (equipmentId) => {\n    const eq = equipment.find(e => e.id === equipmentId);\n    return eq ? eq.name : 'Unknown Equipment';\n  };\n\n  const getStatusColor = (status) => {\n    const colors = {\n      available: 'bg-green-100 text-green-800',\n      unavailable: 'bg-red-100 text-red-800',\n      maintenance: 'bg-yellow-100 text-yellow-800',\n      onduty: 'bg-blue-100 text-blue-800'\n    };\n    return colors[status] || 'bg-gray-100 text-gray-800';\n  };\n\n  const formatCurrency = (amount) => {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'USD'\n    }).format(amount);\n  };\n\n  const formatDate = (dateString) => {\n    return new Date(dateString).toLocaleDateString('en-US', {\n      month: 'short',\n      day: 'numeric',\n      hour: 'numeric',\n      minute: '2-digit'\n    });\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <div className=\"loading-spinner w-12 h-12\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-900\" data-testid=\"fleet-management-title\">\n            Fleet Management\n          </h1>\n          <p className=\"text-gray-600 mt-1\">\n            Comprehensive overview and management of your fleet operations\n          </p>\n        </div>\n        \n        <div className=\"flex items-center space-x-3\">\n          <Button \n            variant=\"outline\" \n            onClick={loadFleetData}\n            data-testid=\"refresh-fleet-data-btn\"\n          >\n            <i className=\"fas fa-sync-alt mr-2\"></i>\n            Refresh Data\n          </Button>\n        </div>\n      </div>\n\n      {/* Fleet Statistics Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n        <Card className=\"dashboard-card\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-gray-600\">Total Equipment</p>\n                <p className=\"text-3xl font-bold text-blue-600\" data-testid=\"total-equipment-count\">\n                  {fleetStats.totalEquipment}\n                </p>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  {fleetStats.availableEquipment} available\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center\">\n                <i className=\"fas fa-truck text-blue-600 text-xl\"></i>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"dashboard-card\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-gray-600\">Fleet Utilization</p>\n                <p className=\"text-3xl font-bold text-green-600\" data-testid=\"utilization-rate\">\n                  {fleetStats.utilizationRate}%\n                </p>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  {fleetStats.onDutyEquipment} units on duty\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center\">\n                <i className=\"fas fa-chart-line text-green-600 text-xl\"></i>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"dashboard-card\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-gray-600\">Active Drivers</p>\n                <p className=\"text-3xl font-bold text-purple-600\" data-testid=\"active-drivers-count\">\n                  {fleetStats.activeDrivers}\n                </p>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  of {fleetStats.totalDrivers} total\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center\">\n                <i className=\"fas fa-users text-purple-600 text-xl\"></i>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"dashboard-card\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-gray-600\">Total Revenue</p>\n                <p className=\"text-3xl font-bold text-orange-600\" data-testid=\"total-revenue\">\n                  {formatCurrency(fleetStats.totalRevenue)}\n                </p>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  {fleetStats.activeBookings} active bookings\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center\">\n                <i className=\"fas fa-dollar-sign text-orange-600 text-xl\"></i>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Main Content Tabs */}\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-5\">\n          <TabsTrigger value=\"overview\" data-testid=\"overview-tab\">\n            <i className=\"fas fa-dashboard mr-2\"></i>\n            Overview\n          </TabsTrigger>\n          <TabsTrigger value=\"equipment\" data-testid=\"equipment-tab\">\n            <i className=\"fas fa-truck mr-2\"></i>\n            Equipment\n          </TabsTrigger>\n          <TabsTrigger value=\"drivers\" data-testid=\"drivers-tab\">\n            <i className=\"fas fa-users mr-2\"></i>\n            Drivers\n          </TabsTrigger>\n          <TabsTrigger value=\"tracking\" data-testid=\"tracking-tab\">\n            <i className=\"fas fa-map-marker-alt mr-2\"></i>\n            Live Tracking\n          </TabsTrigger>\n          <TabsTrigger value=\"analytics\" data-testid=\"analytics-tab\">\n            <i className=\"fas fa-chart-bar mr-2\"></i>\n            Analytics\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Overview Tab */}\n        <TabsContent value=\"overview\" className=\"mt-6\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            {/* Fleet Status Overview */}\n            <Card className=\"dashboard-card\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <i className=\"fas fa-tachometer-alt mr-2 text-blue-600\"></i>\n                  Fleet Status Overview\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {equipment.slice(0, 5).map((item) => (\n                    <div key={item.id} className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg\" data-testid={`fleet-item-${item.id}`}>\n                      <div className=\"flex items-center space-x-3\">\n                        <div className=\"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center\">\n                          <i className=\"fas fa-truck text-blue-600\"></i>\n                        </div>\n                        <div>\n                          <p className=\"font-semibold text-gray-900\">{item.name}</p>\n                          <p className=\"text-sm text-gray-500\">{item.equipment_type?.replace('_', ' ')}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <Badge className={getStatusColor(item.is_available ? 'available' : 'unavailable')}>\n                          {item.is_available ? 'Available' : 'In Use'}\n                        </Badge>\n                        <span className=\"text-sm font-medium text-gray-900\">\n                          {formatCurrency(item.daily_rate)}/day\n                        </span>\n                      </div>\n                    </div>\n                  ))}\n                  \n                  {equipment.length === 0 && (\n                    <div className=\"text-center py-8 text-gray-500\">\n                      <i className=\"fas fa-truck text-4xl mb-4 opacity-50\"></i>\n                      <p>No equipment in your fleet yet</p>\n                      <Button \n                        onClick={() => setActiveTab('equipment')} \n                        className=\"mt-4 btn-primary\"\n                        data-testid=\"add-first-equipment-btn\"\n                      >\n                        Add Your First Equipment\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Recent Activity */}\n            <Card className=\"dashboard-card\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center justify-between\">\n                  <span className=\"flex items-center\">\n                    <i className=\"fas fa-clock mr-2 text-green-600\"></i>\n                    Recent Activity\n                  </span>\n                  <Button size=\"sm\" variant=\"outline\" data-testid=\"view-all-activity-btn\">\n                    View All\n                  </Button>\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {recentActivity.length > 0 ? recentActivity.map((activity) => (\n                    <div key={activity.id} className=\"flex items-start space-x-3 p-3 border-l-4 border-blue-200 bg-blue-50 rounded-r-lg\" data-testid={`activity-${activity.id}`}>\n                      <div className=\"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0\">\n                        <i className=\"fas fa-calendar text-blue-600 text-sm\"></i>\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-sm font-medium text-gray-900\">{activity.description}</p>\n                        <div className=\"flex items-center justify-between mt-1\">\n                          <p className=\"text-xs text-gray-500\">{formatDate(activity.timestamp)}</p>\n                          {activity.amount && (\n                            <span className=\"text-xs font-medium text-green-600\">\n                              {formatCurrency(activity.amount)}\n                            </span>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  )) : (\n                    <div className=\"text-center py-8 text-gray-500\">\n                      <i className=\"fas fa-history text-4xl mb-4 opacity-50\"></i>\n                      <p>No recent activity</p>\n                      <p className=\"text-xs mt-2\">Activity will appear here as you use the platform</p>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Quick Actions */}\n          <Card className=\"dashboard-card mt-6\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center\">\n                <i className=\"fas fa-bolt mr-2 text-yellow-600\"></i>\n                Quick Actions\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                <Button \n                  onClick={() => setActiveTab('equipment')} \n                  className=\"flex flex-col items-center p-6 h-auto space-y-2 bg-gradient-to-br from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 text-blue-700 border-blue-200\"\n                  variant=\"outline\"\n                  data-testid=\"quick-add-equipment-btn\"\n                >\n                  <i className=\"fas fa-plus-circle text-2xl\"></i>\n                  <span>Add Equipment</span>\n                </Button>\n                \n                <Button \n                  onClick={() => setActiveTab('drivers')} \n                  className=\"flex flex-col items-center p-6 h-auto space-y-2 bg-gradient-to-br from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 text-purple-700 border-purple-200\"\n                  variant=\"outline\"\n                  data-testid=\"quick-add-driver-btn\"\n                >\n                  <i className=\"fas fa-user-plus text-2xl\"></i>\n                  <span>Add Driver</span>\n                </Button>\n                \n                <Button \n                  onClick={() => setActiveTab('tracking')} \n                  className=\"flex flex-col items-center p-6 h-auto space-y-2 bg-gradient-to-br from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 text-green-700 border-green-200\"\n                  variant=\"outline\"\n                  data-testid=\"quick-track-fleet-btn\"\n                >\n                  <i className=\"fas fa-map-marked-alt text-2xl\"></i>\n                  <span>Track Fleet</span>\n                </Button>\n                \n                <Button \n                  onClick={() => setActiveTab('analytics')} \n                  className=\"flex flex-col items-center p-6 h-auto space-y-2 bg-gradient-to-br from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 text-orange-700 border-orange-200\"\n                  variant=\"outline\"\n                  data-testid=\"quick-view-analytics-btn\"\n                >\n                  <i className=\"fas fa-chart-line text-2xl\"></i>\n                  <span>View Analytics</span>\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Equipment Tab */}\n        <TabsContent value=\"equipment\" className=\"mt-6\">\n          <EquipmentManagement onStatsUpdate={setFleetStats} />\n        </TabsContent>\n\n        {/* Drivers Tab */}\n        <TabsContent value=\"drivers\" className=\"mt-6\">\n          <DriverManagement onStatsUpdate={setFleetStats} />\n        </TabsContent>\n\n        {/* Live Tracking Tab */}\n        <TabsContent value=\"tracking\" className=\"mt-6\">\n          <LocationTracking />\n        </TabsContent>\n\n        {/* Analytics Tab */}\n        <TabsContent value=\"analytics\" className=\"mt-6\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            {/* Performance Metrics */}\n            <Card className=\"dashboard-card\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <i className=\"fas fa-chart-bar mr-2 text-blue-600\"></i>\n                  Performance Metrics\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-6\">\n                  <div>\n                    <div className=\"flex justify-between items-center mb-2\">\n                      <span className=\"text-sm font-medium text-gray-600\">Fleet Utilization</span>\n                      <span className=\"text-sm font-bold text-blue-600\">{fleetStats.utilizationRate}%</span>\n                    </div>\n                    <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                      <div \n                        className=\"bg-blue-600 h-2 rounded-full transition-all duration-300\" \n                        style={{ width: `${fleetStats.utilizationRate}%` }}\n                      ></div>\n                    </div>\n                  </div>\n                  \n                  <div>\n                    <div className=\"flex justify-between items-center mb-2\">\n                      <span className=\"text-sm font-medium text-gray-600\">Driver Efficiency</span>\n                      <span className=\"text-sm font-bold text-green-600\">87%</span>\n                    </div>\n                    <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                      <div className=\"bg-green-600 h-2 rounded-full transition-all duration-300\" style={{ width: '87%' }}></div>\n                    </div>\n                  </div>\n                  \n                  <div>\n                    <div className=\"flex justify-between items-center mb-2\">\n                      <span className=\"text-sm font-medium text-gray-600\">Equipment Health</span>\n                      <span className=\"text-sm font-bold text-yellow-600\">92%</span>\n                    </div>\n                    <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                      <div className=\"bg-yellow-500 h-2 rounded-full transition-all duration-300\" style={{ width: '92%' }}></div>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Revenue Analytics */}\n            <Card className=\"dashboard-card\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <i className=\"fas fa-dollar-sign mr-2 text-green-600\"></i>\n                  Revenue Analytics\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  <div className=\"flex justify-between items-center p-4 bg-green-50 rounded-lg\">\n                    <div>\n                      <p className=\"text-sm font-medium text-gray-600\">This Month</p>\n                      <p className=\"text-2xl font-bold text-green-600\">{formatCurrency(fleetStats.totalRevenue * 0.3)}</p>\n                    </div>\n                    <i className=\"fas fa-arrow-up text-green-600 text-xl\"></i>\n                  </div>\n                  \n                  <div className=\"flex justify-between items-center p-4 bg-blue-50 rounded-lg\">\n                    <div>\n                      <p className=\"text-sm font-medium text-gray-600\">Average per Equipment</p>\n                      <p className=\"text-2xl font-bold text-blue-600\">\n                        {formatCurrency(fleetStats.totalEquipment > 0 ? fleetStats.totalRevenue / fleetStats.totalEquipment : 0)}\n                      </p>\n                    </div>\n                    <i className=\"fas fa-calculator text-blue-600 text-xl\"></i>\n                  </div>\n                  \n                  <div className=\"flex justify-between items-center p-4 bg-purple-50 rounded-lg\">\n                    <div>\n                      <p className=\"text-sm font-medium text-gray-600\">Projected Annual</p>\n                      <p className=\"text-2xl font-bold text-purple-600\">{formatCurrency(fleetStats.totalRevenue * 4)}</p>\n                    </div>\n                    <i className=\"fas fa-chart-line text-purple-600 text-xl\"></i>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Equipment Type Distribution */}\n          <Card className=\"dashboard-card mt-6\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center\">\n                <i className=\"fas fa-pie-chart mr-2 text-orange-600\"></i>\n                Fleet Composition\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                {equipment.reduce((acc, item) => {\n                  const type = item.equipment_type?.replace('_', ' ').toUpperCase();\n                  acc[type] = (acc[type] || 0) + 1;\n                  return acc;\n                }, {})}\n                \n                {Object.entries(\n                  equipment.reduce((acc, item) => {\n                    const type = item.equipment_type?.replace('_', ' ').toUpperCase();\n                    acc[type] = (acc[type] || 0) + 1;\n                    return acc;\n                  }, {})\n                ).map(([type, count]) => (\n                  <div key={type} className=\"flex items-center justify-between p-4 bg-gray-50 rounded-lg\">\n                    <div>\n                      <p className=\"font-semibold text-gray-900\">{type}</p>\n                      <p className=\"text-sm text-gray-500\">{count} units</p>\n                    </div>\n                    <div className=\"text-2xl font-bold text-blue-600\">\n                      {Math.round((count / fleetStats.totalEquipment) * 100)}%\n                    </div>\n                  </div>\n                ))}\n                \n                {equipment.length === 0 && (\n                  <div className=\"col-span-full text-center py-8 text-gray-500\">\n                    <i className=\"fas fa-chart-pie text-4xl mb-4 opacity-50\"></i>\n                    <p>No equipment data available</p>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n};\n\nexport default FleetManagement;"