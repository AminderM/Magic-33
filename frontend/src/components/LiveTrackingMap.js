import React, { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useAuth } from '../contexts/AuthContext';\nimport { toast } from 'sonner';\n\nconst LiveTrackingMap = () => {\n  const { user, fetchWithAuth } = useAuth();\n  const [vehicles, setVehicles] = useState([]);\n  const [selectedVehicle, setSelectedVehicle] = useState('');\n  const [connectionStatus, setConnectionStatus] = useState('disconnected');\n  const [loading, setLoading] = useState(true);\n\n  const BACKEND_URL = process.env.REACT_APP_BACKEND_URL;\n\n  useEffect(() => {\n    loadVehicles();\n  }, []);\n\n  const loadVehicles = async () => {\n    try {\n      const response = await fetchWithAuth(`${BACKEND_URL}/api/equipment/my`);\n      if (response.ok) {\n        const equipmentData = await response.json();\n        \n        // Transform equipment data to vehicle format with simulated locations\n        const vehicleData = equipmentData.map((equipment, index) => ({\n          id: equipment.id,\n          name: equipment.name,\n          type: equipment.equipment_type,\n          driver: `Driver ${index + 1}`,\n          status: 'active',\n          speed: Math.floor(Math.random() * 60),\n          // Simulate locations around Los Angeles\n          latitude: 34.0522 + (Math.random() - 0.5) * 0.1,\n          longitude: -118.2437 + (Math.random() - 0.5) * 0.1,\n          lastUpdate: new Date().toISOString(),\n          battery: Math.floor(Math.random() * 100)\n        }));\n        \n        setVehicles(vehicleData);\n        setConnectionStatus('connected');\n        toast.success('Fleet data loaded successfully');\n      }\n    } catch (error) {\n      console.error('Error loading vehicles:', error);\n      toast.error('Failed to load vehicles');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const getStatusColor = (status) => {\n    const colors = {\n      active: 'bg-green-100 text-green-800',\n      idle: 'bg-yellow-100 text-yellow-800',\n      offline: 'bg-red-100 text-red-800',\n      maintenance: 'bg-purple-100 text-purple-800'\n    };\n    return colors[status] || 'bg-gray-100 text-gray-800';\n  };\n\n  const formatLastUpdate = (timestamp) => {\n    const now = new Date();\n    const update = new Date(timestamp);\n    const diffMs = now - update;\n    const diffMins = Math.floor(diffMs / 60000);\n    \n    if (diffMins < 1) return 'Just now';\n    if (diffMins < 60) return `${diffMins}m ago`;\n    const diffHours = Math.floor(diffMins / 60);\n    return `${diffHours}h ago`;\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <div className=\"loading-spinner w-12 h-12\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header and Controls */}\n      <div className=\"flex flex-col lg:flex-row gap-6\">\n        <Card className=\"flex-1\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center justify-between\">\n              <span className=\"flex items-center\">\n                <i className=\"fas fa-map-marked-alt mr-2 text-blue-600\"></i>\n                Live Fleet Tracking\n              </span>\n              <div className=\"flex items-center space-x-2\">\n                <Badge className={connectionStatus === 'connected' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}>\n                  <i className={`fas ${connectionStatus === 'connected' ? 'fa-wifi' : 'fa-wifi-slash'} mr-1`}></i>\n                  {connectionStatus === 'connected' ? 'Connected' : 'Disconnected'}\n                </Badge>\n              </div>\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-wrap gap-4 items-center\">\n              <div className=\"flex items-center space-x-2\">\n                <Select value={selectedVehicle} onValueChange={setSelectedVehicle}>\n                  <SelectTrigger className=\"w-48\">\n                    <SelectValue placeholder=\"Focus on vehicle\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"\">All Vehicles</SelectItem>\n                    {vehicles.map(vehicle => (\n                      <SelectItem key={vehicle.id} value={vehicle.id}>\n                        {vehicle.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div className=\"text-sm text-gray-600\">\n                <i className=\"fas fa-truck mr-2\"></i>\n                {vehicles.length} vehicles tracked\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Map Placeholder and Vehicle List */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Map Placeholder */}\n        <div className=\"lg:col-span-2\">\n          <Card className=\"h-[600px]\">\n            <CardContent className=\"p-0 h-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100\">\n              <div className=\"text-center p-8\">\n                <div className=\"text-6xl text-blue-600 mb-6\">\n                  <i className=\"fas fa-map\"></i>\n                </div>\n                <h3 className=\"text-2xl font-bold text-gray-900 mb-4\">Interactive Map Loading...</h3>\n                <p className=\"text-gray-600 mb-6\">\n                  Live vehicle tracking map with OpenStreetMap integration\n                </p>\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div className=\"bg-white rounded-lg p-4\">\n                    <div className=\"text-blue-600 text-lg font-bold\">{vehicles.length}</div>\n                    <div>Active Vehicles</div>\n                  </div>\n                  <div className=\"bg-white rounded-lg p-4\">\n                    <div className=\"text-green-600 text-lg font-bold\">\n                      {vehicles.filter(v => v.status === 'active').length}\n                    </div>\n                    <div>Online Now</div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n        \n        {/* Vehicle List */}\n        <div className=\"lg:col-span-1\">\n          <Card className=\"h-[600px]\">\n            <CardHeader>\n              <CardTitle className=\"text-lg\">\n                <i className=\"fas fa-list mr-2\"></i>\n                Fleet Status\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-0\">\n              <div className=\"max-h-[520px] overflow-y-auto\">\n                {vehicles.map(vehicle => (\n                  <div\n                    key={vehicle.id}\n                    className={`p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors ${\n                      selectedVehicle === vehicle.id ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''\n                    }`}\n                    onClick={() => setSelectedVehicle(vehicle.id)}\n                    data-testid={`vehicle-item-${vehicle.id}`}\n                  >\n                    <div className=\"flex items-start justify-between mb-2\">\n                      <div className=\"flex-1 min-w-0\">\n                        <h4 className=\"font-semibold text-sm truncate\">{vehicle.name}</h4>\n                        <p className=\"text-xs text-gray-600\">{vehicle.driver}</p>\n                      </div>\n                      <Badge className={getStatusColor(vehicle.status)} size=\"sm\">\n                        {vehicle.status}\n                      </Badge>\n                    </div>\n                    \n                    <div className=\"space-y-1 text-xs text-gray-600\">\n                      <div className=\"flex justify-between\">\n                        <span>Speed:</span>\n                        <span className={vehicle.speed > 0 ? 'text-green-600 font-medium' : ''}>\n                          {vehicle.speed} mph\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span>Battery:</span>\n                        <span className={vehicle.battery < 20 ? 'text-red-600 font-bold' : ''}>\n                          {vehicle.battery}%\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span>Updated:</span>\n                        <span>{formatLastUpdate(vehicle.lastUpdate)}</span>\n                      </div>\n                    </div>\n                    \n                    <div className=\"mt-2 flex items-center justify-between\">\n                      <div className={`w-2 h-2 rounded-full ${\n                        vehicle.status === 'active' ? 'bg-green-500' :\n                        vehicle.status === 'idle' ? 'bg-yellow-500' : 'bg-red-500'\n                      }`}></div>\n                      <span className=\"text-xs text-gray-500\">\n                        {Math.round(vehicle.latitude * 1000) / 1000}, {Math.round(vehicle.longitude * 1000) / 1000}\n                      </span>\n                    </div>\n                  </div>\n                ))}\n                \n                {vehicles.length === 0 && (\n                  <div className=\"p-8 text-center text-gray-500\">\n                    <i className=\"fas fa-truck text-3xl mb-3 opacity-50\"></i>\n                    <p>No vehicles to track</p>\n                    <p className=\"text-xs mt-2\">Add equipment to see live tracking</p>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Mobile Access Instructions */}\n      <Card className=\"dashboard-card\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center\">\n            <i className=\"fas fa-mobile-alt mr-2 text-purple-600\"></i>\n            Mobile Driver Access\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"bg-purple-50 border border-purple-200 rounded-lg p-4\">\n            <h4 className=\"font-semibold text-purple-900 mb-2\">Driver Mobile Interface</h4>\n            <p className=\"text-purple-800 text-sm mb-3\">\n              Drivers can access real-time tracking through their mobile devices using vehicle-specific URLs:\n            </p>\n            <div className=\"bg-white rounded border p-3 font-mono text-sm text-gray-700\">\n              https://freight-fleet.preview.emergentagent.com/mobile/[VEHICLE_ID]\n            </div>\n            <div className=\"mt-3 text-xs text-purple-700\">\n              <p><strong>Features:</strong> GPS tracking, status updates, emergency alerts, battery monitoring</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default LiveTrackingMap;"