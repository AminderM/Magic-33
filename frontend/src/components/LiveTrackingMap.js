import React, { useState, useEffect, useRef } from 'react';\nimport { MapContainer, TileLayer, Marker, Popup, Polyline, useMap } from 'react-leaflet';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useAuth } from '../contexts/AuthContext';\nimport { toast } from 'sonner';\nimport useWebSocket from 'use-websocket';\nimport L from 'leaflet';\nimport 'leaflet/dist/leaflet.css';\n\n// Fix default markers for Leaflet\ndelete L.Icon.Default.prototype._getIconUrl;\nL.Icon.Default.mergeOptions({\n  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',\n  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',\n  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png'\n});\n\n// Custom vehicle icons\nconst createVehicleIcon = (type, status, color = '#3b82f6') => {\n  const iconMap = {\n    'box_truck': 'üöõ',\n    'sprinter_van': 'üöê',\n    'hvac_truck': 'üîß',\n    'crane': 'üèóÔ∏è',\n    'flatbed_truck': 'üöö',\n    'dry_van': 'üì¶',\n    'reefer': 'üßä',\n    'big_rig': 'üöõ',\n    'forklift': 'üöú',\n    'excavator': '‚õèÔ∏è'\n  };\n\n  const statusColors = {\n    'active': '#10b981',\n    'idle': '#f59e0b', \n    'offline': '#ef4444',\n    'maintenance': '#8b5cf6'\n  };\n\n  const actualColor = statusColors[status] || color;\n  const emoji = iconMap[type] || 'üöó';\n\n  return L.divIcon({\n    html: `\n      <div style=\"\n        background-color: ${actualColor};\n        width: 40px;\n        height: 40px;\n        border-radius: 50%;\n        border: 3px solid white;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 16px;\n        position: relative;\n      \">\n        ${emoji}\n        <div style=\"\n          position: absolute;\n          bottom: -5px;\n          right: -5px;\n          width: 12px;\n          height: 12px;\n          background-color: ${actualColor};\n          border-radius: 50%;\n          border: 2px solid white;\n        \"></div>\n      </div>\n    `,\n    className: 'vehicle-marker',\n    iconSize: [40, 40],\n    iconAnchor: [20, 40],\n    popupAnchor: [0, -40]\n  });\n};\n\n// Map bounds updater component\nfunction MapBoundsUpdater({ vehicles, selectedVehicle }) {\n  const map = useMap();\n  \n  useEffect(() => {\n    if (selectedVehicle) {\n      const vehicle = vehicles.find(v => v.id === selectedVehicle);\n      if (vehicle && vehicle.latitude && vehicle.longitude) {\n        map.setView([vehicle.latitude, vehicle.longitude], 16);\n      }\n    } else if (vehicles.length > 0) {\n      const validVehicles = vehicles.filter(v => v.latitude && v.longitude);\n      if (validVehicles.length > 0) {\n        const bounds = L.latLngBounds(validVehicles.map(v => [v.latitude, v.longitude]));\n        map.fitBounds(bounds, { padding: [20, 20] });\n      }\n    }\n  }, [map, vehicles, selectedVehicle]);\n  \n  return null;\n}\n\nconst LiveTrackingMap = () => {\n  const { user, fetchWithAuth } = useAuth();\n  const [vehicles, setVehicles] = useState([]);\n  const [selectedVehicle, setSelectedVehicle] = useState('');\n  const [showRoutes, setShowRoutes] = useState(false);\n  const [trackingEnabled, setTrackingEnabled] = useState(false);\n  const [connectionStatus, setConnectionStatus] = useState('disconnected');\n  const [locationHistory, setLocationHistory] = useState({});\n  const mapRef = useRef();\n\n  const BACKEND_URL = process.env.REACT_APP_BACKEND_URL;\n  const WS_URL = BACKEND_URL ? BACKEND_URL.replace('https://', 'wss://').replace('http://', 'ws://') : 'ws://localhost:8001';\n\n  // WebSocket connection for real-time updates\n  const { lastMessage, connectionStatus: wsStatus, sendJsonMessage } = useWebSocket(\n    `${WS_URL}/ws/fleet-tracking`,\n    {\n      onOpen: () => {\n        console.log('WebSocket connection opened');\n        setConnectionStatus('connected');\n        toast.success('Live tracking connected');\n      },\n      onClose: () => {\n        console.log('WebSocket connection closed');\n        setConnectionStatus('disconnected');\n        toast.info('Live tracking disconnected');\n      },\n      onError: (error) => {\n        console.error('WebSocket error:', error);\n        setConnectionStatus('error');\n        toast.error('Connection error occurred');\n      },\n      shouldReconnect: (closeEvent) => true,\n      reconnectAttempts: 10,\n      reconnectInterval: 3000\n    }\n  );\n\n  // Load initial vehicle data\n  useEffect(() => {\n    loadVehicles();\n  }, []);\n\n  // Process WebSocket messages\n  useEffect(() => {\n    if (lastMessage !== null) {\n      try {\n        const data = JSON.parse(lastMessage.data);\n        console.log('Received location update:', data);\n        \n        if (data.type === 'location_update') {\n          updateVehicleLocation(data.payload);\n        } else if (data.type === 'vehicle_status') {\n          updateVehicleStatus(data.payload);\n        }\n      } catch (error) {\n        console.error('Error parsing WebSocket message:', error);\n      }\n    }\n  }, [lastMessage]);\n\n  const loadVehicles = async () => {\n    try {\n      const response = await fetchWithAuth(`${BACKEND_URL}/api/equipment/my`);\n      if (response.ok) {\n        const equipmentData = await response.json();\n        \n        // Transform equipment data to vehicle format with simulated locations\n        const vehicleData = equipmentData.map((equipment, index) => ({\n          id: equipment.id,\n          name: equipment.name,\n          type: equipment.equipment_type,\n          driver: `Driver ${index + 1}`,\n          status: 'active',\n          speed: 0,\n          heading: 0,\n          // Simulate locations around a central point (you can replace with real data)\n          latitude: 34.0522 + (Math.random() - 0.5) * 0.1,\n          longitude: -118.2437 + (Math.random() - 0.5) * 0.1,\n          lastUpdate: new Date().toISOString(),\n          battery: Math.floor(Math.random() * 100),\n          odometer: Math.floor(Math.random() * 10000)\n        }));\n        \n        setVehicles(vehicleData);\n        \n        // Start simulated movement for demo\n        if (vehicleData.length > 0) {\n          startSimulatedMovement(vehicleData);\n        }\n      }\n    } catch (error) {\n      console.error('Error loading vehicles:', error);\n      toast.error('Failed to load vehicles');\n    }\n  };\n\n  const updateVehicleLocation = (locationData) => {\n    setVehicles(prev => prev.map(vehicle => {\n      if (vehicle.id === locationData.vehicle_id) {\n        return {\n          ...vehicle,\n          latitude: locationData.latitude,\n          longitude: locationData.longitude,\n          speed: locationData.speed || 0,\n          heading: locationData.heading || 0,\n          lastUpdate: locationData.timestamp || new Date().toISOString()\n        };\n      }\n      return vehicle;\n    }));\n\n    // Store location history for routes\n    setLocationHistory(prev => ({\n      ...prev,\n      [locationData.vehicle_id]: [\n        ...(prev[locationData.vehicle_id] || []).slice(-50), // Keep last 50 points\n        {\n          lat: locationData.latitude,\n          lng: locationData.longitude,\n          timestamp: locationData.timestamp || new Date().toISOString()\n        }\n      ]\n    }));\n  };\n\n  const updateVehicleStatus = (statusData) => {\n    setVehicles(prev => prev.map(vehicle => {\n      if (vehicle.id === statusData.vehicle_id) {\n        return {\n          ...vehicle,\n          status: statusData.status,\n          battery: statusData.battery || vehicle.battery\n        };\n      }\n      return vehicle;\n    }));\n  };\n\n  // Simulate vehicle movement for demo purposes\n  const startSimulatedMovement = (initialVehicles) => {\n    const moveVehicles = () => {\n      setVehicles(prev => prev.map(vehicle => {\n        // Small random movement\n        const newLat = vehicle.latitude + (Math.random() - 0.5) * 0.001;\n        const newLng = vehicle.longitude + (Math.random() - 0.5) * 0.001;\n        const newSpeed = Math.floor(Math.random() * 60);\n        const newHeading = Math.floor(Math.random() * 360);\n        \n        // Simulate different statuses\n        const statuses = ['active', 'idle', 'active', 'active']; // More likely to be active\n        const newStatus = statuses[Math.floor(Math.random() * statuses.length)];\n        \n        return {\n          ...vehicle,\n          latitude: newLat,\n          longitude: newLng,\n          speed: newSpeed,\n          heading: newHeading,\n          status: newStatus,\n          lastUpdate: new Date().toISOString()\n        };\n      }));\n    };\n\n    // Move vehicles every 5 seconds\n    const interval = setInterval(moveVehicles, 5000);\n    return () => clearInterval(interval);\n  };\n\n  const toggleTracking = () => {\n    setTrackingEnabled(!trackingEnabled);\n    if (!trackingEnabled) {\n      toast.success('Live tracking enabled');\n    } else {\n      toast.info('Live tracking paused');\n    }\n  };\n\n  const centerOnVehicle = (vehicleId) => {\n    setSelectedVehicle(vehicleId);\n  };\n\n  const getStatusColor = (status) => {\n    const colors = {\n      active: 'bg-green-100 text-green-800',\n      idle: 'bg-yellow-100 text-yellow-800',\n      offline: 'bg-red-100 text-red-800',\n      maintenance: 'bg-purple-100 text-purple-800'\n    };\n    return colors[status] || 'bg-gray-100 text-gray-800';\n  };\n\n  const formatLastUpdate = (timestamp) => {\n    const now = new Date();\n    const update = new Date(timestamp);\n    const diffMs = now - update;\n    const diffMins = Math.floor(diffMs / 60000);\n    \n    if (diffMins < 1) return 'Just now';\n    if (diffMins < 60) return `${diffMins}m ago`;\n    const diffHours = Math.floor(diffMins / 60);\n    return `${diffHours}h ago`;\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header and Controls */}\n      <div className=\"flex flex-col lg:flex-row gap-6\">\n        <Card className=\"flex-1\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center justify-between\">\n              <span className=\"flex items-center\">\n                <i className=\"fas fa-map-marked-alt mr-2 text-blue-600\"></i>\n                Live Fleet Tracking\n              </span>\n              <div className=\"flex items-center space-x-2\">\n                <Badge className={connectionStatus === 'connected' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}>\n                  <i className={`fas ${connectionStatus === 'connected' ? 'fa-wifi' : 'fa-wifi-slash'} mr-1`}></i>\n                  {connectionStatus === 'connected' ? 'Connected' : 'Disconnected'}\n                </Badge>\n                <Button\n                  onClick={toggleTracking}\n                  className={trackingEnabled ? 'bg-red-600 hover:bg-red-700' : 'btn-primary'}\n                  size=\"sm\"\n                  data-testid=\"toggle-tracking-btn\"\n                >\n                  <i className={`fas ${trackingEnabled ? 'fa-pause' : 'fa-play'} mr-2`}></i>\n                  {trackingEnabled ? 'Pause' : 'Start'} Tracking\n                </Button>\n              </div>\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-wrap gap-4 items-center\">\n              <div className=\"flex items-center space-x-2\">\n                <Select value={selectedVehicle} onValueChange={setSelectedVehicle}>\n                  <SelectTrigger className=\"w-48\">\n                    <SelectValue placeholder=\"Focus on vehicle\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"\">All Vehicles</SelectItem>\n                    {vehicles.map(vehicle => (\n                      <SelectItem key={vehicle.id} value={vehicle.id}>\n                        {vehicle.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <Button\n                variant=\"outline\"\n                onClick={() => setShowRoutes(!showRoutes)}\n                size=\"sm\"\n                data-testid=\"toggle-routes-btn\"\n              >\n                <i className=\"fas fa-route mr-2\"></i>\n                {showRoutes ? 'Hide' : 'Show'} Routes\n              </Button>\n              \n              <div className=\"text-sm text-gray-600\">\n                <i className=\"fas fa-truck mr-2\"></i>\n                {vehicles.length} vehicles tracked\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Map and Vehicle List */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n        {/* Map */}\n        <div className=\"lg:col-span-3\">\n          <Card className=\"h-[600px]\">\n            <CardContent className=\"p-0 h-full\">\n              <MapContainer\n                center={[34.0522, -118.2437]} // Los Angeles default\n                zoom={12}\n                style={{ height: '100%', width: '100%' }}\n                ref={mapRef}\n                className=\"rounded-lg\"\n              >\n                <TileLayer\n                  url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n                  attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n                />\n                \n                <MapBoundsUpdater vehicles={vehicles} selectedVehicle={selectedVehicle} />\n                \n                {/* Vehicle Markers */}\n                {vehicles.map(vehicle => (\n                  vehicle.latitude && vehicle.longitude && (\n                    <Marker\n                      key={vehicle.id}\n                      position={[vehicle.latitude, vehicle.longitude]}\n                      icon={createVehicleIcon(vehicle.type, vehicle.status)}\n                    >\n                      <Popup>\n                        <div className=\"p-2 min-w-[200px]\">\n                          <h3 className=\"font-semibold text-lg mb-2\">{vehicle.name}</h3>\n                          <div className=\"space-y-2 text-sm\">\n                            <div className=\"flex justify-between\">\n                              <span>Driver:</span>\n                              <span className=\"font-medium\">{vehicle.driver}</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                              <span>Status:</span>\n                              <Badge className={getStatusColor(vehicle.status)}>\n                                {vehicle.status}\n                              </Badge>\n                            </div>\n                            <div className=\"flex justify-between\">\n                              <span>Speed:</span>\n                              <span>{vehicle.speed} mph</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                              <span>Last Update:</span>\n                              <span>{formatLastUpdate(vehicle.lastUpdate)}</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                              <span>Battery:</span>\n                              <span className={vehicle.battery < 20 ? 'text-red-600 font-bold' : ''}>\n                                {vehicle.battery}%\n                              </span>\n                            </div>\n                          </div>\n                          <div className=\"mt-3 space-y-2\">\n                            <Button \n                              size=\"sm\" \n                              className=\"w-full\"\n                              onClick={() => centerOnVehicle(vehicle.id)}\n                            >\n                              <i className=\"fas fa-crosshairs mr-2\"></i>\n                              Center on Vehicle\n                            </Button>\n                          </div>\n                        </div>\n                      </Popup>\n                    </Marker>\n                  )\n                ))}\n                \n                {/* Historical Routes */}\n                {showRoutes && Object.entries(locationHistory).map(([vehicleId, history]) => {\n                  const vehicle = vehicles.find(v => v.id === vehicleId);\n                  if (!vehicle || history.length < 2) return null;\n                  \n                  return (\n                    <Polyline\n                      key={`route-${vehicleId}`}\n                      positions={history.map(h => [h.lat, h.lng])}\n                      color={vehicle.status === 'active' ? '#10b981' : '#f59e0b'}\n                      weight={3}\n                      opacity={0.7}\n                    />\n                  );\n                })}\n              </MapContainer>\n            </CardContent>\n          </Card>\n        </div>\n        \n        {/* Vehicle List */}\n        <div className=\"lg:col-span-1\">\n          <Card className=\"h-[600px]\">\n            <CardHeader>\n              <CardTitle className=\"text-lg\">\n                <i className=\"fas fa-list mr-2\"></i>\n                Fleet Status\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-0\">\n              <div className=\"max-h-[520px] overflow-y-auto\">\n                {vehicles.map(vehicle => (\n                  <div\n                    key={vehicle.id}\n                    className={`p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors ${\n                      selectedVehicle === vehicle.id ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''\n                    }`}\n                    onClick={() => centerOnVehicle(vehicle.id)}\n                    data-testid={`vehicle-item-${vehicle.id}`}\n                  >\n                    <div className=\"flex items-start justify-between mb-2\">\n                      <div className=\"flex-1 min-w-0\">\n                        <h4 className=\"font-semibold text-sm truncate\">{vehicle.name}</h4>\n                        <p className=\"text-xs text-gray-600\">{vehicle.driver}</p>\n                      </div>\n                      <Badge className={getStatusColor(vehicle.status)} size=\"sm\">\n                        {vehicle.status}\n                      </Badge>\n                    </div>\n                    \n                    <div className=\"space-y-1 text-xs text-gray-600\">\n                      <div className=\"flex justify-between\">\n                        <span>Speed:</span>\n                        <span className={vehicle.speed > 0 ? 'text-green-600 font-medium' : ''}>\n                          {vehicle.speed} mph\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span>Battery:</span>\n                        <span className={vehicle.battery < 20 ? 'text-red-600 font-bold' : ''}>\n                          {vehicle.battery}%\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span>Updated:</span>\n                        <span>{formatLastUpdate(vehicle.lastUpdate)}</span>\n                      </div>\n                    </div>\n                    \n                    <div className=\"mt-2 flex items-center justify-between\">\n                      <div className={`w-2 h-2 rounded-full ${\n                        vehicle.status === 'active' ? 'bg-green-500' :\n                        vehicle.status === 'idle' ? 'bg-yellow-500' : 'bg-red-500'\n                      }`}></div>\n                      <span className=\"text-xs text-gray-500\">\n                        {Math.round(vehicle.latitude * 1000) / 1000}, {Math.round(vehicle.longitude * 1000) / 1000}\n                      </span>\n                    </div>\n                  </div>\n                ))}\n                \n                {vehicles.length === 0 && (\n                  <div className=\"p-8 text-center text-gray-500\">\n                    <i className=\"fas fa-truck text-3xl mb-3 opacity-50\"></i>\n                    <p>No vehicles to track</p>\n                    <p className=\"text-xs mt-2\">Add equipment to see live tracking</p>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default LiveTrackingMap;"